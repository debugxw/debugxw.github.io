---
title: DNS解析
excerpt: 域名和IP地址之间的一种转换机制
date: 2021-12-01
tags: 网络
toc: false
image: /img/theme/030.jpg
---

最近写了一个新的服务，需要将其部署在公司的rancher上面，同时提供公网域名。于是依葫芦画瓢，按照rancher已有域名的配置，配置上我自己的服务。公司已有二级域名：```company.com```，之前能够访问的域名地址为：```https://old.company.com/old/path```。我新增加了域名```new.company.com```，并将```/new/path```打到了我的新服务上面。但是配置完了之后，死活无法正常访问，问题如下：

```https://new.company.com/new/path```无法访问，但是如果将域名配置成```old.company.com```，也就是```https://old.company.com/new/path```则能正常访问

经过一番努力，最终发现是DNS相关的问题。正好来整理下DNS

## 域名服务器
因为互联网是全球资源，单一的域名服务器肯定不足以支撑全部的地址转换操作，同时由于域名是层级结构，所以域名服务器也是对应的层级结构，不同的域名服务器之间相互协作，共同完成全球互联网的地址转换工作

![域名服务器分级](../../../../img/net/DNS_域名服务器分级.png)

上图展示了DNS服务器的部分层级结构，从上到下依次为根域名服务器、顶级域名服务器、权限域名服务器
+ **根域名服务器**：根域名服务器是最高层次的域名服务器，它知道所有顶级域名服务器的地址
+ **顶级域名服务器**：顶级域名服务器负责管理该服务器下的所有二级域名
+ **权限域名服务器**：负责某一个区域的域名服务器，也就是管理该二级域名下的所有三级域名
+ **本地域名服务器**：每一个互联网服务提供者ISP都可以是一个本地域名服务器

**8.8.8.8、114.114.114.114这些域名服务器属于是哪一类域名服务器？**
+ 8.8.8.8是谷歌向全球用户提供的一个免费域名服务器，并且其响应速度快、安全、可靠
+ 114.114.114.114是中国电信提供的免费域名服务器，也是移动、电信、联通三大运营商通用的域名服务器

从本质上来说，上面的这两个都是本地域名服务器，只不过他们都开放给了互联网上的所有用户
但是也有另一种说法，上面这两个不属于上述任意一个域名服务器，而应该称为**公共域名服务器**。但这感觉也是在抠字眼、概念，而从概念上来说，很多公司都搭建有自己的域名服务器，而这种才称之为真正的本地域名服务器，如果公司不想要在你上班的时候摸鱼，那么它就可以在这个本地域名服务器上边做一层拦截，比如禁用bilibili，而如果你使用的刚好是公司的域名服务器，那么这个时候你就没办法访问类似于bilibili这样的娱乐性网站

## DNS解析过程
查询域名对应的IP地址一般分为两种方式：递归查询和迭代查询
+ 递归查询：客户端向服务器发出查询请求，如果服务器需要再向其他服务器查询才能得知结果，那么服务器直接向其他服务器发送请求，处理之后将最终结果发送给客户端
+ 迭代查询：客户端向服务器发出查询请求，如果服务器需要再向其他服务器查询才能得知结果，那么服务器直接告诉客户端其他服务器的地址，并由客户端再次向其他服务器发出查询请求

综合考虑，DNS解析从主机到本地域名服务器的查询为递归查询，从本地域名服务器到其他域名服务器的查询为迭代查询，查询过程如下所示

![DNS解析过程](../../../../img/net/DNS解析过程.png)

0. 依次查询浏览器缓存、本地HOST（有些路由器也会有域名缓存），命中缓存则结束
1. 主机向本地域名服务器发起查询请求，如果本地域名服务器命中缓存，则直接返回
2. 本地域名服务器向某一个根域名服务器发起查询请求
3. 根域名服务器告诉本地域名服务器接下来该去哪一个顶级域名服务器查询
4. 本地域名服务器向顶级域名服务器发起查询请求
5. 顶级域名服务器告诉本地域名服务器接下来该去哪一个权限域名服务器查询
6. 本地域名服务器向权限域名服务器发起查询请求
7. 权限域名服务器告诉本地域名服务器查询结果
8. 本地域名服务器告诉主机查询结果

## 总结
对于文章开头遇到的问题，那么也就明了了，对于域名```old.company.com```，本地域名服务器是能够解析的，但是对于```new.company.com```，只有根域名服务器、顶级域名服务器能够解析，但是到了权限域名服务器这里，就没有办法解析了，因为```new```这个三级域名是没有配置的